<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <title>Swagger Api Gen</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body class="p-3 m-0 border-0">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

    <div class="row g-3">
      <div class="col-12">
        <label for="service" class="form-label">生成Service 文件路径</label>
        <input
          type="input"
          class="form-control"
          id="service"
          placeholder="/services/base/brand.ts"
        />
      </div>

      <div id="list" class="col-12" onclick="onDelegation(event)">
        <div>
          <label for="basic-url" class="form-label">填写路由</label>
          <button name="add" type="button" class="btn btn-primary">添加</button>
        </div>
        <div class="input-group mb-3">
          <select name="method" type="text" class="form-control method">
            <option value="get">Get</option>
            <option selected value="post">Post</option>
          </select>

          <input
            type="text"
            class="form-control url"
            name="url"
            placeholder="接口请求路径: /admin/media/refluxCategory/addPropertyBinding"
          />
          <button name="delete" type="button" class="btn btn-danger">
            删除
          </button>
        </div>
      </div>

      <div>
        <button type="button" class="btn btn-primary" onclick="handleSubmit()">
          提交
        </button>
      </div>
    </div>
    <script>
      let vscode;
      try {
        vscode = acquireVsCodeApi && acquireVsCodeApi();
      } catch (error) {}

      function handleSubmit() {
        const servicePath = $("#service").val();
        const routes = [];
        $("#list .input-group").each(function () {
          const instance = $(this);
          const method = instance.find("[name='method']").val();
          const url = instance.find("[name='url']").val();
          routes.push({ method, url });
        });
        const data = { servicePath, routes };
        console.log("data", data);
        vscode.postMessage(data);
      }
      function onDelegation(event) {
        if (event.target.name === "add") {
          onAdd(event);
        } else if (event.target.name === "delete") {
          onRemove(event);
        }
      }

      function onAdd(event) {
        const root = document.getElementById("list");

        $("#list").append(`<div class="input-group mb-3">
          <select name="method" type="text" class="form-control method">
            <option value="get">Get</option>
            <option selected value="post">Post</option>
          </select>

          <input
            type="text"
            class="form-control url"
            name="url"
            placeholder="接口请求路径: /admin/media/refluxCategory/addPropertyBinding"
          />
          <button name="delete" type="button" class="btn btn-danger">
            删除
          </button>
        </div>`);
      }

      function onRemove(event) {
        const root = document.getElementById("list");
        let curNode = event.target.parentElement;
        while (curNode) {
          if (curNode.parentElement === root) {
            root.removeChild(curNode);
            return;
          }
          curNode = curNode.parentElement;
        }
      }

      function onMessage(event) {
        const message = event.data; // The JSON data our extension sent
        console.log("vscode => message", message);
      }

      window.addEventListener("message", onMessage);
    </script>
  </body>
</html>
